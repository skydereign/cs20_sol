<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Level Editor</title>

<script>
window.onload = function() {
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	
	var cellSize = 40;
	
	var grid = new Array(canvas.width/cellSize);
	for(i=0; i < grid.length; i++){
		grid[i] = new Array(canvas.height/cellSize);
	}
	//tileNum corresponds to which tile within the tilesheet is being used.
	var tileNum;
/* 	window.addEventListener('keydown', function(event){
		if(event.keyCode === 49){
			tileNum = 1;
		}else if(event.keyCode === 50){
			tileNum = 2;
		}else if(event.keyCode === 51){
			tileNum = 3;
		}else if(event.keyCode === 52){
			tileNum = 4;
		}
	});
*/
	
	//when mouse button is down, set grid cell to current tileNum
	var flag = false;
	canvas.onmousedown = function(e){
		flag = true;

		for(i = 0; i < tileTotal; i++){
			if(tileNum == i){
				grid[Math.floor((e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - 11)/cellSize)][Math.floor((e.clientY + document.body.scrollTop + document.documentElement.scrollTop - 11)/cellSize)] = i;
			}
		}
	}
	document.onmouseup = function(){
		flag = false;
	}

	//if mouse is dragged, then change all grid cells that the mouse touches to current tileNum
	canvas.onmousemove = function(e){
		if(flag){
			for(i = 0; i < tileTotal; i++){
				if(tileNum == i){
					grid[Math.floor((e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - 11)/cellSize)][Math.floor((e.clientY + document.body.scrollTop + document.documentElement.scrollTop - 11)/cellSize)] = i;
				}
			}
		}
	}
	//Store tiles into Array
	var  image = document.getElementById("tiles");
	image.crossOrigin = "anonymous";
	ctx.drawImage(image, 0, 0);
	var imgArray = new Array();
	var tileTotal = (image.height/cellSize) * (image.width/cellSize);
	for(y = 0; y < image.height; y += 40){
		for(x = 0; x < image.width; x += 40){
			imgArray.push(ctx.getImageData(x, y, 40, 40));
		}
	}
	//Clicking on image will set tileNum to corresponding tile that was clicked
	image.onclick = function(e){
		clickX = e.clientX-this.offsetLeft + document.body.scrollLeft;
		clickY = e.clientY-this.offsetTop + document.body.scrollTop;

		for(j = 0; j < image.height; j += 40){
			for(i = 0; i < image.width; i += 40){
				if(clickX >= i && clickX <= i + 40 && clickY >= j && clickY <= j + 40)
					tileNum = (i+(j*image.width/40))/40;
			}
		}
		console.log(tileNum);
	}
	setInterval(drawLevel, 50);
	//Compares each grid cell with a possible tile number and if there is a match, draw that tile inside the the cell.
	function drawLevel(){
		ctx.clearRect(0,0,canvas.width,canvas.height);
		for(i = 0; i < canvas.width/cellSize; i++){
			for(j = 0; j < canvas.height/cellSize; j++){
				for(t = 0; t <= tileTotal; t++){
					if(grid[i][j] == t){
						ctx.putImageData(imgArray[t], i*cellSize, j*cellSize)
					}
				}

			}
		}
	}
}
</script>
</head>
<body>
<canvas id = "canvas" width = "800" height = "560" style = "border:solid black;">
</canvas>
<img id = "tiles" src = "tiles_concept.png">
</body>
</html>