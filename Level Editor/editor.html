<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Level Editor</title>

<script>
window.onload = function() {
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	var p = document.getElementById("para");
	
	var cellSize = 40;
	
	var background = new Array(canvas.width/cellSize);
	for(i=0; i < background.length; i++){
		background[i] = new Array(canvas.height/cellSize);
	}
	var foreground = new Array(canvas.width/cellSize);
	for(i=0; i < foreground.length; i++){
		foreground[i] = new Array(canvas.height/cellSize);
	}
	var middleground = new Array(canvas.width/cellSize);
	for(i=0; i < middleground.length; i++){
		middleground[i] = new Array(canvas.height/cellSize);
	}
	//tileNum corresponds to which tile within the tilesheet is being used.
	var tileNum;
 	window.addEventListener('keydown', function(event){
		if(event.keyCode === 49){
			ground = "b";
			p.innerHTML = "On BackGround";
		}
		else if(event.keyCode === 50){
			ground = "m";
			p.innerHTML = "On MiddleGround";
		}
		else if(event.keyCode === 51){
			ground = "f";
			p.innerHTML = "On ForeGround";
		}/*else if(event.keyCode === 52){
			tileNum = 4;
		}*/
	});

	
	//when mouse button is down, set grid cell to current tileNum
	var mouseFlag = false;
	var ground = "b";
	
	canvas.onmousedown = function(e){
		mouseFlag = true;
		for(i = 0; i < tileTotal; i++){
			if(tileNum == i && ground == "b"){
				background[Math.floor((e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - 11)/cellSize)][Math.floor((e.clientY + document.body.scrollTop + document.documentElement.scrollTop - 11)/cellSize)] = i;
			}else if(tileNum == i && ground == "f"){
				foreground[Math.floor((e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - 11)/cellSize)][Math.floor((e.clientY + document.body.scrollTop + document.documentElement.scrollTop - 11)/cellSize)] = i;
			}else if(tileNum == i && ground == "m"){
				middleground[Math.floor((e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - 11)/cellSize)][Math.floor((e.clientY + document.body.scrollTop + document.documentElement.scrollTop - 11)/cellSize)] = i;
			}
		}
	}
	document.onmouseup = function(){
		mouseFlag = false;
	}

	//if mouse is dragged, then change all grid cells that the mouse touches to current tileNum
	canvas.onmousemove = function(e){
		if(mouseFlag){
			for(i = 0; i < tileTotal; i++){
				if(tileNum == i && ground == "b"){
					background[Math.floor((e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - 11)/cellSize)][Math.floor((e.clientY + document.body.scrollTop + document.documentElement.scrollTop - 11)/cellSize)] = i;
				}else if(tileNum == i && ground == "f"){
					foreground[Math.floor((e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - 11)/cellSize)][Math.floor((e.clientY + document.body.scrollTop + document.documentElement.scrollTop - 11)/cellSize)] = i;				
				}else if(tileNum == i && ground == "m"){
					middleground[Math.floor((e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - 11)/cellSize)][Math.floor((e.clientY + document.body.scrollTop + document.documentElement.scrollTop - 11)/cellSize)] = i;				
				}
			}
		}
	}
	//Store tiles into Array
	var  image = document.getElementById("tiles");
	var tilesPerRow = image.width/cellSize;
	var tilesPerCol = image.height/cellSize;
	var tileTotal = (tilesPerRow) * (tilesPerCol);
	
	//Clicking on image will set tileNum to corresponding tile that was clicked
	image.onclick = function(e){
		clickX = e.clientX-this.offsetLeft + document.body.scrollLeft;
		clickY = e.clientY-this.offsetTop + document.body.scrollTop;

		for(j = 0; j < image.height; j += 40){
			for(i = 0; i < image.width; i += 40){
				if(clickX >= i && clickX <= i + 40 && clickY >= j && clickY <= j + 40)
					tileNum = (i+(j*image.width/40))/40;
			}
		}
		console.log(tileNum);
	}
	setInterval(drawLevel, 50);
	//Compares each grid cell with a possible tile number and if there is a match, draw that tile inside the the cell.
	function drawLevel(){
		ctx.clearRect(0,0,canvas.width,canvas.height);
		for(i = 0; i < canvas.width/cellSize; i++){
			for(j = 0; j < canvas.height/cellSize; j++){
				for(t = 0; t <= tileTotal; t++){
					if(background[i][j] == t){
						ctx.drawImage(image, 40*(t%tilesPerRow), Math.floor(t/tilesPerRow)*40, 40, 40, i*cellSize, j*cellSize, 40, 40);
					}
				}
				for(t=0; t<=tileTotal; t++){
					if(middleground[i][j] == t){
						ctx.drawImage(image, 40*(t%tilesPerRow), Math.floor(t/tilesPerRow)*40, 40, 40, i*cellSize, j*cellSize, 40, 40);				
					}
				}
				for(t=0; t<=tileTotal; t++){
					if(foreground[i][j] == t){
						ctx.drawImage(image, 40*(t%tilesPerRow), Math.floor(t/tilesPerRow)*40, 40, 40, i*cellSize, j*cellSize, 40, 40);				
					}
				}

			}
		}
	}
	function readSingleFile(evt){
		var f = evt.target.files[0];
		
		if(f){
			var r = new FileReader();
			r.onload = function(e){
				var contents = e.target.result;
				var line = contents.substr(0, contents.indexOf("\n"));
				var n = line.split(" ");
				var gridWidth = parseInt(n[0]);
				var gridHeight = parseInt(n[1]);
				canvas.width = gridWidth * cellSize;
				canvas.height = gridHeight * cellSize;

				line = contents.substring(contents.indexOf('b'), contents.indexOf('m'));
				n = line.split(" ");
				console.log(line);
				//console.log(n);
				t = 1;
				for(j=0; j < gridHeight; j++){
					for(i = 0; i < gridWidth; i++){
						if(t%(gridWidth + 1) == 0){
							t++;
						}
						background[i][j] = n[t++];
					}
				}
				line = contents.substring(contents.indexOf('m'), contents.indexOf('f'));
				n = line.split(" ");
				t = 1;
				for(j=0; j < gridHeight; j++){
					for(i = 0; i < gridWidth; i++){
						if(t%(gridWidth + 1) == 0){
							t++;
						}
						middleground[i][j] = n[t++];
					}
				}
				line = contents.substring(contents.indexOf('f'), contents.indexOf('e'));
				n = line.split(" ");
				t = 1;
				for(j=0; j < gridHeight; j++){
					for(i = 0; i < gridWidth; i++){
						if(t%(gridWidth + 1) == 0){
							t++;
						}
						foreground[i][j] = n[t++];
					}
				}
			}
			r.readAsText(f);
		}else{
			alert("Failed to load file");
		}
	}
	document.getElementById('fileinput').addEventListener('change', readSingleFile, false);
}
</script>
</head>
<body>
<canvas id = "canvas" width = "800" height = "560" style = "border:solid black;">
</canvas>
<img id = "tiles" src = "tiles_concept_01.png"><br>
Key 1 for BackGround<br>
Key 2 for MiddleGround<br>
Key 3 for ForeGround<br>
<p id = "para">On BackGround</p>
<button onclick="loadMap();">Save</button> <input type="file" id="fileinput" />

</body>
</html>